<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.lishangbu.orange.authorization.mapper.OauthAuthorizationMapper">
    <!-- OauthAuthorization 实体映射 -->
    <resultMap id="OauthAuthorizationResultMap" type="io.github.lishangbu.orange.authorization.entity.OauthAuthorization">
        <id property="id" column="id" />
        <result property="authorizationObject" column="authorization_object"/>
        <result property="registeredClientId" column="registered_client_id" />
        <result property="principalName" column="principal_name" />
        <result property="authorizationGrantType" column="authorization_grant_type" />
        <result property="authorizedScopes" column="authorized_scopes" />
        <result property="attributes" column="attributes" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
        <result property="state" column="state" />
        <result property="authorizationCodeValue" column="authorization_code_value" />
        <result property="authorizationCodeIssuedAt" column="authorization_code_issued_at" />
        <result property="authorizationCodeExpiresAt" column="authorization_code_expires_at" />
        <result property="authorizationCodeMetadata" column="authorization_code_metadata" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
        <result property="accessTokenValue" column="access_token_value" />
        <result property="accessTokenIssuedAt" column="access_token_issued_at" />
        <result property="accessTokenExpiresAt" column="access_token_expires_at" />
        <result property="accessTokenMetadata" column="access_token_metadata" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
        <result property="accessTokenScopes" column="access_token_scopes" />
        <result property="oidcIdTokenValue" column="oidc_id_token_value" />
        <result property="oidcIdTokenIssuedAt" column="oidc_id_token_issued_at" />
        <result property="oidcIdTokenExpiresAt" column="oidc_id_token_expires_at" />
        <result property="oidcIdTokenMetadata" column="oidc_id_token_metadata" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
        <result property="oidcIdTokenClaims" column="oidc_id_token_claims" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
        <result property="refreshTokenValue" column="refresh_token_value" />
        <result property="refreshTokenIssuedAt" column="refresh_token_issued_at" />
        <result property="refreshTokenExpiresAt" column="refresh_token_expires_at" />
        <result property="refreshTokenMetadata" column="refresh_token_metadata" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
        <result property="userCodeValue" column="user_code_value" />
        <result property="userCodeIssuedAt" column="user_code_issued_at" />
        <result property="userCodeExpiresAt" column="user_code_expires_at" />
        <result property="userCodeMetadata" column="user_code_metadata" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
        <result property="deviceCodeValue" column="device_code_value" />
        <result property="deviceCodeIssuedAt" column="device_code_issued_at" />
        <result property="deviceCodeExpiresAt" column="device_code_expires_at" />
        <result property="deviceCodeMetadata" column="device_code_metadata" typeHandler="io.github.lishangbu.orange.mybatisplus.extension.handlers.Jackson3TypeHandler" />
    </resultMap>
    <!-- 查询所有字段列表 -->
    <sql id="selectAllOauthAuthorizationColumnsSql">
      SELECT
        id,
        authorization_object,
        registered_client_id,
        principal_name,
        authorization_grant_type,
        authorized_scopes,
        attributes,
        state,
        authorization_code_value,
        authorization_code_issued_at,
        authorization_code_expires_at,
        authorization_code_metadata,
        access_token_value,
        access_token_issued_at,
        access_token_expires_at,
        access_token_metadata,
        access_token_scopes,
        oidc_id_token_value,
        oidc_id_token_issued_at,
        oidc_id_token_expires_at,
        oidc_id_token_metadata,
        oidc_id_token_claims,
        refresh_token_value,
        refresh_token_issued_at,
        refresh_token_expires_at,
        refresh_token_metadata,
        user_code_value,
        user_code_issued_at,
        user_code_expires_at,
        user_code_metadata,
        device_code_value,
        device_code_issued_at,
        device_code_expires_at,
        device_code_metadata
      FROM oauth_authorization
    </sql>
    <!-- 根据 state 查询认证信息 -->
    <select id="selectByState" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        state=#{state}
      </where>
    </select>
    <!-- 根据授权码查询认证信息 -->
    <select id="selectByAuthorizationCodeValue" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        authorization_code_value=#{authorizationCode}
      </where>
    </select>
    <!-- 根据访问令牌查询认证信息 -->
    <select id="selectByAccessTokenValue" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        access_token_value=#{accessToken}
      </where>
    </select>
    <!-- 根据刷新令牌查询认证信息 -->
    <select id="selectByRefreshTokenValue" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        refresh_token_value = #{refreshToken}
      </where>
    </select>
    <!-- 根据 OIDC ID Token 查询认证信息 -->
    <select id="selectByOidcIdTokenValue" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        oidc_id_token_value = #{idToken}
      </where>
    </select>
    <!-- 根据用户码查询认证信息 -->
    <select id="selectByUserCodeValue" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        user_code_value = #{userCode}
      </where>
    </select>
    <!-- 根据设备码查询认证信息 -->
    <select id="selectByDeviceCodeValue" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        device_code_value = #{deviceCode}
      </where>
    </select>
    <!-- 根据多种 token 字段联合查询认证信息 -->
    <select id="selectByTokenValue" resultMap="OauthAuthorizationResultMap" parameterType="string">
      <include refid="selectAllOauthAuthorizationColumnsSql"/>
      <where>
        state = #{token}
        OR authorization_code_value = #{token}
        OR access_token_value = #{token}
        OR refresh_token_value = #{token}
        OR oidc_id_token_value = #{token}
        OR user_code_value = #{token}
        OR device_code_value = #{token}
      </where>
    </select>
</mapper>
